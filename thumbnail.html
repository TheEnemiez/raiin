<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>RAIIN</title>
		<link rel="stylesheet" href="styles.css" />
	</head>
	<body>
		<div id="notification" class="notification hidden"></div>

		<header>
			<pre>
      :::::::::      :::     ::::::::::: ::::::::::: ::::    ::: 
     :+:    :+:   :+: :+:       :+:         :+:     :+:+:   :+:  
    +:+    +:+  +:+   +:+      +:+         +:+     +:+     +:+   
   +#++:++#:  +#++:++#++:     +#+         +#+     +#+ +:+ +#+    
  +#+    +#+ +#+     +#+     +#+         +#+     +#+  +#+#+#     
 #+#    #+# #+#     #+#     #+#         #+#     #+#   #+#+#      
###    ### ###     ### ########### ########### ###    ####       
        </pre
			>
			<h1>Welcome to RAIIN</h1>
		</header>
		<nav>
			<ul>
				<li><a href="services.html">Services</a></li>
				<li><a href="how-to-order.html">How to Order</a></li>
				<li><a href="payment-information.html">Payment Information</a></li>
				<li><a href="receive.html">Receive Your Order</a></li>
				<li><a href="terms-and-conditions.html">Terms and Conditions</a></li>
				<li><a href="contact-us.html">Contact Us</a></li>
				<li><a href="prices.html">Price Calculator</a></li>
			</ul>
		</nav>
		<nav>
			<ul>
				<li><a href="cloak.html">Cloak Form</a></li>
				<li><a href="sky.html">Sky Form</a></li>
				<li><a href="thumbnail.html">Thumbnail Form</a></li>
			</ul>
		</nav>

		<main>
			<form id="thumbnailForm" class="form-grid">
				<h2>Thumbnail Form</h2>
				<div class="form-row">
					<label for="additionalThumbnails">Additional Thumbnails:</label>
					<input type="number" id="additionalThumbnails" name="additionalThumbnails" min="0" max="10" oninput="updateThumbnailSelect()" />
				</div>
				<div id="thumbnailSelectContainer" class="form-row">
					<label for="thumbnailSelect">Select Thumbnail</label>
					<select id="thumbnailSelect" name="thumbnailSelect" class="form-control">
						<option value="0">Main Thumbnail</option>
					</select>
				</div>
				<div id="thumbnails">
					<div class="thumbnail-group" id="thumbnail0">
						<h3>Main Thumbnail</h3>
						<div class="form-group">
							<label for="description0">Description</label>
							<textarea id="description0" name="description0" class="form-control auto-expand"></textarea>
						</div>
					</div>
				</div>
				<div class="form-row">
					<label for="thumbnailDiscount">Discount (% or Code):</label>
					<textarea type="text" id="thumbnailDiscount" name="thumbnailDiscount" class="form-control" oninput="validateDiscount(this)"></textarea>
				</div>
				<div class="form-row">
					<button type="button" onclick="calculatePriceAndExportJSON()">Calculate Price & Export JSON</button>
					<button type="button" onclick="showImportPopup()">Import</button>
					<input type="file" id="importFile" style="display: none" accept=".json" onchange="handleFileImport(event)" />
					<button type="button" id="copyJsonButton" class="hidden" onclick="copyJson()">Copy JSON</button>
				</div>

				<div id="jsonOutputContainer" class="form-row hidden">
					<h3>JSON Output:</h3>
					<div id="jsonDisplay" class="json-display"></div>
					<input type="hidden" id="jsonOutputHidden" />
				</div>
				<div id="result" class="hidden"></div>
			</form>
		</main>

		<footer>
			<div class="footer-content">
				<p>Contact us: <a href="https://discord.gg/x5xzeb9JBR">RAIIN Discord</a> | @TheEnemiez</p>
				<ul class="social-links">
					<li><a href="https://www.youtube.com/@TheEnemiez">TheEnemiez YT</a><br /></li>
					<li><a href="https://www.youtube.com/@Cookiehh">Cookiehh YT</a><br /></li>
				</ul>
				<p>© 2024 RAIIN. All rights reserved.</p>
			</div>
		</footer>
		<script>
			function handleFileImport(event) {
				const file = event.target.files[0];
				if (file && file.type === "application/json") {
					const reader = new FileReader();
					reader.onload = (e) => {
						try {
							const jsonString = e.target.result;
							importJson(jsonString);
						} catch (error) {
							showNotification("Error importing JSON: " + error.message, `7F2B2B`, "FF5555");
						}
					};
					reader.onerror = () => {
						showNotification("Error reading file", `7F2B2B`, "FF5555");
					};
					reader.readAsText(file);
				} else {
					showNotification("Please select a valid JSON file", `7F2B2B`, "FF5555");
				}
			}

			function showNotification(message, bgColor = "000000", textColor = "ffffff") {
				const notification = document.getElementById("notification");
				notification.textContent = message;
				notification.style.backgroundColor = `#${bgColor}`;
				notification.style.color = `#${textColor}`;

				// Prevent multiple rapid notifications from causing flickering
				if (notification.hideTimeout) {
					clearTimeout(notification.hideTimeout); // Clear existing timeout
				}

				notification.classList.remove("hidden");
				notification.classList.add("visible");

				// Hide the notification after 3 seconds using requestAnimationFrame for smoother animation
				notification.hideTimeout = setTimeout(() => {
					requestAnimationFrame(() => {
						notification.classList.remove("visible");
						notification.classList.add("hidden");
					});
				}, 3000);
			}

			function showDetailedPopup(details) {
				// Remove any existing popup and overlay before creating new ones
				document.querySelectorAll(".detailed-popup, .blur-overlay").forEach((element) => element.remove());

				const overlay = document.createElement("div");
				overlay.classList.add("blur-overlay");
				document.body.appendChild(overlay);

				const detailedPopup = document.createElement("div");
				detailedPopup.classList.add("detailed-popup");

				const content = document.createElement("div");
				content.classList.add("content");
				content.innerHTML = `<p>${details.join("<br>")}</p>`;

				const closeButton = document.createElement("button");
				closeButton.textContent = "Close";
				closeButton.onclick = () => {
					detailedPopup.remove();
					overlay.remove();
					hideNotification();
					document.body.classList.remove("no-scroll"); // Enable scrolling
				};

				content.appendChild(closeButton);
				detailedPopup.appendChild(content);

				document.body.appendChild(detailedPopup);
				document.body.classList.add("no-scroll"); // Disable scrolling
			}

			function hideNotification() {
				const notification = document.getElementById("notification");
				notification.classList.remove("visible");
				notification.classList.add("hidden");
			}

			function updatePrice(type, index) {
				// Only handling description for thumbnail
			}

			function getThumbnailType(index) {
				const additionalThumbnailsCount = parseInt(document.getElementById("additionalThumbnails").value, 10) || 0;
				if (index === 0) return "main";
				return "additional";
			}

			function getThumbnailFormData() {
				const formData = new FormData(document.getElementById("thumbnailForm"));
				const data = {
					additionalThumbnails: formData.get("additionalThumbnails"),
					thumbnails: [],
				};

				const additionalThumbnailsCount = parseInt(data.additionalThumbnails, 10) || 0;
				const thumbnailCount = additionalThumbnailsCount + 1;

				for (let i = 0; i < thumbnailCount; i++) {
					const thumbnail = {
						type: i === 0 ? "main" : "additional",
						description: formData.get(`description${i}`),
					};

					data.thumbnails.push(thumbnail);
				}

				return data;
			}

			function updateThumbnailSelect() {
				const additionalThumbnails = document.getElementById("additionalThumbnails");

				// Ensure the value does not exceed 10
				additionalThumbnails.value = Math.min(additionalThumbnails.value, 10);

				const additionalThumbnailsCount = parseInt(additionalThumbnails.value, 10) || 0;
				const totalThumbnailsCount = additionalThumbnailsCount + 1;

				const thumbnailsContainer = document.getElementById("thumbnails");
				const thumbnailSelect = document.getElementById("thumbnailSelect");

				// Save existing form data
				const existingData = getThumbnailFormData();

				// Reset the dropdown and thumbnails container
				thumbnailSelect.innerHTML = '<option value="0">Main Thumbnail</option>';
				thumbnailsContainer.innerHTML = createThumbnailGroup("Main Thumbnail", 0);

				// Create additional thumbnails
				for (let i = 1; i < totalThumbnailsCount; i++) {
					const title = `Additional Thumbnail ${i}`;
					thumbnailSelect.innerHTML += `<option value="${i}">${title}</option>`;
					thumbnailsContainer.innerHTML += createThumbnailGroup(title, i);
				}

				// Restore form data
				setThumbnailFormData(existingData);

				// Show the first thumbnail group
				document.getElementById("thumbnail0").style.display = "block";

				// Update all prices
				for (let i = 0; i < totalThumbnailsCount; i++) {
					updatePrice("description", i);
				}
			}

			function createThumbnailGroup(title, index) {
				return `
			 <div class="thumbnail-group" id="thumbnail${index}" style="display: none;">
			     <h3>${title}</h3>
			     <div class="form-group">
			         <label for="description${index}">Description</label>
			         <textarea id="description${index}" name="description${index}" class="form-control auto-expand"></textarea>
			     </div>
			 </div>
			 `;
			}

			function calculateThumbnailPrice() {
				const formData = getThumbnailFormData(); // Assuming getThumbnailFormData() retrieves form data
				if (!formData) return 0;

				let totalPrice = 0;

				formData.thumbnails.forEach((thumbnail, index) => {
					const basePrice = getThumbnailBasePrice(thumbnail, index);
					totalPrice += basePrice;
				});

				const discount = parseFloat(document.getElementById("thumbnailDiscount").value) || 0;
				const discountedPrice = totalPrice * (1 - discount / 100);

				return discountedPrice.toFixed(2);
			}

			function getThumbnailBasePrice(thumbnail, index) {
				let basePrice = 2; // Default base price for thumbnail
				const isMainThumbnail = index === 0;
				const isAdditionalThumbnail = thumbnail.type === "additional";

				if (isMainThumbnail) basePrice = 2;
				if (isAdditionalThumbnail) basePrice = 1;

				return basePrice;
			}

			function calculatePriceAndExportJSON() {
				clearErrorMessages();

				let formData;
				let priceBreakdown = [];
				let totalPrice = 0;
				let discountedPrice = 0;

				if (!validateForm()) {
					return;
				}

				formData = getThumbnailFormData();
				if (!formData) {
					return;
				}

				formData.thumbnails.forEach((thumbnail, index) => {
					const basePrice = getThumbnailBasePrice(thumbnail, index);
					let thumbnailPrice = basePrice;
					let details = `Thumbnail ${index + 1} (${thumbnail.type}): ${basePrice.toFixed(2)}€`;

					priceBreakdown.push(details);
					totalPrice += thumbnailPrice;
				});

				const discountValue = document.getElementById("thumbnailDiscount").value.trim();
				const discount = parseFloat(discountValue);

				if (isNaN(discount) && discountValue !== "") {
					formData.code = discountValue;
					priceBreakdown.push(`Discount Code Applied: ${discountValue}`);
				} else if (!isNaN(discount) && discount > 0) {
					priceBreakdown.push(`Discount Applied: ${discount}%`);
					totalPrice *= 1 - discount / 100;
				}

				discountedPrice = totalPrice.toFixed(2);
				showNotification(`Total Thumbnail Price: ${discountedPrice}€`, `2C7F2C`, `55ff55`);

				let summary = priceBreakdown.join("<br>");
				const formattedJsonString = JSON.stringify(formData, null, 2);
				const compactJsonString = JSON.stringify(formData);

				const lines = formattedJsonString.split("\n");
				const maxLines = 10;
				const visibleLines = lines.slice(0, maxLines).join("\n");
				const isOverflow = lines.length > maxLines;

				const jsonDisplay = document.getElementById("jsonDisplay");
				jsonDisplay.innerHTML = visibleLines + (isOverflow ? "\n..." : "");

				document.getElementById("jsonOutputHidden").value = compactJsonString;

				document.getElementById("copyJsonButton").classList.remove("hidden");
				document.getElementById("jsonOutputContainer").classList.remove("hidden");

				const result = document.getElementById("result");
				result.innerHTML = summary + `<h3>Total Price: ${discountedPrice}€</h3>`;
				result.classList.remove("hidden");
			}

			function displayJsonFormatted(jsonString) {
				const lines = jsonString.split("\n");
				const maxLines = 10;
				const visibleLines = lines.slice(0, maxLines).join("\n");
				const isOverflow = lines.length > maxLines;

				const jsonDisplay = document.getElementById("jsonDisplay");
				jsonDisplay.innerHTML = visibleLines + (isOverflow ? "\n..." : "");
			}

			function copyJson() {
				const jsonOutputHidden = document.getElementById("jsonOutputHidden");

				// Copy compact JSON to clipboard
				navigator.clipboard
					.writeText(jsonOutputHidden.value)
					.then(() => {
						showNotification("JSON copied to clipboard", `2C7F2C`, `55ff55`);

						// Clear all cache after copying JSON
						localStorage.clear();

						// Clear the form data
						document.getElementById("thumbnailForm").reset();
						updateThumbnailSelect();

						// Hide JSON output container and copy button
						const jsonOutputContainer = document.getElementById("jsonOutputContainer");
						const copyJsonButton = document.getElementById("copyJsonButton");
						const jsonDisplay = document.getElementById("jsonDisplay");

						jsonOutputContainer.classList.add("hidden");
						copyJsonButton.classList.add("hidden");

						// Clear JSON display and hidden input
						jsonDisplay.innerHTML = "";
						jsonOutputHidden.value = "";

						// Clear the result summary
						const result = document.getElementById("result");
						result.classList.add("hidden");
						result.innerHTML = "";

						// Clear any previous error messages
						clearErrorMessages();
					})
					.catch((err) => {
						showNotification("Failed to copy JSON", `7F2B2B`, `ff5555`);
						console.error("Could not copy text: ", err);
					});
			}

			function showImportPopup() {
				const createElementWithClass = (tag, ...classNames) => {
					const element = document.createElement(tag);
					classNames.forEach((className) => element.classList.add(className));
					return element;
				};

				const overlay = createElementWithClass("div", "blur-overlay");
				const popup = createElementWithClass("div", "detailed-popup");
				const content = createElementWithClass("div", "content");

				const textarea = createElementWithClass("textarea", "form-control", "auto-expand", "import-textarea");
				textarea.rows = 10;
				textarea.placeholder = "Paste your JSON here...";

				const importButton = createElementWithClass("button");
				importButton.textContent = "Import JSON";
				importButton.onclick = () => {
					importJson(textarea.value);
					overlay.remove();
					popup.remove();
					document.body.classList.remove("no-scroll");
				};

				const closeButton = createElementWithClass("button");
				closeButton.textContent = "Close";
				closeButton.onclick = () => {
					overlay.remove();
					popup.remove();
					document.body.classList.remove("no-scroll");
				};

				content.appendChild(textarea);
				content.appendChild(importButton);
				content.appendChild(closeButton);
				popup.appendChild(content);

				document.body.appendChild(overlay);
				document.body.appendChild(popup);
				document.body.classList.add("no-scroll");
			}

			function clearErrorMessages() {
				document.querySelectorAll(".detailed-popup, .blur-overlay").forEach((element) => element.remove());
			}

			function importJson(jsonString) {
				try {
					const jsonData = JSON.parse(jsonString);
					setThumbnailFormData(jsonData);
					showNotification("JSON imported successfully", `2C7F2C`, `55ff55`);

					// Clear the JSON output and result summary after importing
					const jsonOutputContainer = document.getElementById("jsonOutputContainer");
					const copyJsonButton = document.getElementById("copyJsonButton");
					const jsonDisplay = document.getElementById("jsonDisplay");
					const jsonOutputHidden = document.getElementById("jsonOutputHidden");
					const result = document.getElementById("result");

					jsonOutputContainer.classList.add("hidden");
					copyJsonButton.classList.add("hidden");
					jsonDisplay.innerHTML = "";
					jsonOutputHidden.value = "";
					result.classList.add("hidden");
					result.innerHTML = "";

					// Clear any previous error messages
					clearErrorMessages();
				} catch (error) {
					showNotification("Invalid JSON format", `7F2B2B`, `ff5555`);
				}
			}
			function validateDiscount(input) {
				const discountValue = input.value.trim();
				console.log("Validating discount value:", discountValue); // Log the discount value being validated
				const discountPattern = /^(?!.*\s)(\d{1,2}(\.\d{1})?|100|[A-Za-z0-9]{6})$/;

				if (discountValue === "") {
					console.log("Discount value is empty, setting to blank."); // Log the case when the input is empty
					input.value = ""; // Allow blank input
				} else if (!discountPattern.test(discountValue)) {
					console.log("Discount value is invalid:", discountValue); // Log the invalid discount value
					input.value = discountValue.slice(0, -1); // Remove the last character
				}
			}

			// Updated validateForm function
			function validateForm() {
				let valid = true;
				const messages = [];

				document.querySelectorAll(".thumbnail-group").forEach((group) => {
					const index = group.id.replace("thumbnail", "");
					const description = document.getElementById(`description${index}`);

					if (!description.value.trim()) {
						messages.push(`${group.querySelector("h3").textContent} description is required.`);
						valid = false;
					}
				});

				const discountInput = document.getElementById("thumbnailDiscount").value.trim();
				if (discountInput !== "") {
					const discountPattern = /^([0-9]{1,2}(\.[0-9]{1})?|100|[A-Za-z0-9]{6})$/;
					if (!discountPattern.test(discountInput)) {
						messages.push("Invalid discount. Enter a number between 0 and 100 or a valid code.");
						valid = false;
					}
				}

				if (!valid) {
					showNotification("There are errors in the form. Click for details.", `7F2B2B`, `ff5555`);
					document.getElementById("notification").onclick = () => showDetailedPopup(messages);
				}

				return valid;
			}

			function setThumbnailFormData(data) {
				try {
					const setElementValue = (id, value, defaultValue = "") => {
						const element = document.getElementById(id);
						if (element) element.value = value || defaultValue;
					};

					// Thumbnail part
					if (data.additionalThumbnails !== undefined) {
						setElementValue("additionalThumbnails", data.additionalThumbnails);

						const additionalThumbnailsCount = parseInt(data.additionalThumbnails, 10) || 0;
						const totalThumbnailsCount = additionalThumbnailsCount + 1;

						const thumbnailsContainer = document.getElementById("thumbnails");
						const thumbnailSelect = document.getElementById("thumbnailSelect");

						// Clear existing thumbnails and dropdown options
						thumbnailSelect.innerHTML = '<option value="0">Main Thumbnail</option>';
						thumbnailsContainer.innerHTML = createThumbnailGroup("Main Thumbnail", 0);

						// Create additional thumbnails
						for (let i = 1; i <= additionalThumbnailsCount; i++) {
							thumbnailSelect.innerHTML += `<option value="${i}">Additional Thumbnail ${i}</option>`;
							thumbnailsContainer.innerHTML += createThumbnailGroup(`Additional Thumbnail ${i}`, i);
						}

						// Set form data for each thumbnail if data.thumbnails is defined
						if (data.thumbnails) {
							data.thumbnails.forEach((thumbnail, index) => {
								setElementValue(`description${index}`, thumbnail.description, "");
							});

							// Ensure the first thumbnail group is visible
							document.getElementById("thumbnail0").style.display = "block";
						}
					}
				} catch (error) {
					console.error("Error loading form data:", error);
					showNotification("Error loading imported data.", `7F2B2B`, `ff5555`);
				}
			}

			function autoExpand(field) {
				field.style.height = "inherit";

				// Calculate the new height
				const computed = window.getComputedStyle(field);
				const height = parseInt(computed.getPropertyValue("border-top-width"), 10) + parseInt(computed.getPropertyValue("padding-top"), 10) + field.scrollHeight + parseInt(computed.getPropertyValue("padding-bottom"), 10) + parseInt(computed.getPropertyValue("border-bottom-width"), 10);

				// Apply the calculated height to the textarea
				field.style.height = `${height - 25}px`;
			}

			function saveProgress() {
				const formData = getThumbnailFormData();
				localStorage.setItem("thumbnailFormData", JSON.stringify(formData));
			}

			function loadProgress() {
				const savedData = localStorage.getItem("thumbnailFormData");
				let dataToLoad = savedData ? JSON.parse(savedData) : {};
				setThumbnailFormData(dataToLoad);
			}

			document.addEventListener("DOMContentLoaded", () => {
				document.getElementById("additionalThumbnails").addEventListener("input", updateThumbnailSelect);

				document.getElementById("thumbnailSelect").addEventListener("change", (event) => {
					const selectedThumbnail = event.target.value;
					document.querySelectorAll(".thumbnail-group").forEach((group) => {
						group.style.display = group.id === `thumbnail${selectedThumbnail}` ? "block" : "none";
					});
					updatePrice("description", selectedThumbnail);
				});

				document.addEventListener("input", (event) => {
					if (event.target.tagName.toLowerCase() === "textarea" && event.target.classList.contains("auto-expand")) {
						autoExpand(event.target);
					}
					if (event.target.id === "thumbnailDiscount") {
						validateDiscount(event.target);
					}
				});

				// Load progress and initialize thumbnail select
				loadProgress();
				updateThumbnailSelect();

				setInterval(saveProgress, 500);
			});
		</script>
	</body>
</html>
